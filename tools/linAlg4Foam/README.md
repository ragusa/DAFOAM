# Linear algebra for OpenFOAM

The 'linAlg4Foam.py' contains a collection of field operations which are done inside the 
OpenFOAM environment and can be directly called from python.

## Installation

Download zip or tar.gz file and extract it. 


## Usage

Import the linAlg4Foam into your script as:
```
from linAlg4Foam import linAlg4Foam
```

Then, refer to the utilities as:
```
linAlg4Foam.utility(arguments)
```

If the default directory structure generated by the `snapshot_manager.py` is changed, relative path from OpenFOAM virtual folder to the snapshots location should be adjusted accordingly. The `relative_path` variable is defined in 'basicFunction.py' as:
```
relative_path = "../symlinked_cases/"
```

Check test.py for examples off all implemented functions.


## Functions

### Basic utilities

#### Extracting minimal and maximal values
`fieldMinMax` and `internalFieldMinMax` return the minimal and maximal values of the fields along with the location.

Input example
```
from linAlg4Foam import linAlg4Foam

# Path to virtual OpenFoam directory
virtual_OF_dir = "OpenFoamTestCase/virtual_OF"

snapshots_list =[
    '1/100',
    '3/5'
]

fields = ['T', 'DT']

## Returning minimal and maximal values of a field
minima, maxima = linAlg4Foam.fieldMinMax(virtual_OF_dir, snapshots_list, fields)
for item in minima:
    print(item)
for item in maxima:
    print(item)

## Returning minimal and maximal values of internal field
minima, maxima = linAlg4Foam.internalFieldMinMax(virtual_OF_dir, snapshots_list, fields)
for item in minima:
    print(item)
for item in maxima:
    print(item)
```

Output example
```
...
{'snapshotID': '1/100', 'field': 'T', 'position': '(0.464286 0.0294118 0.05)', 'value': 300.132}
{'snapshotID': '1/100', 'field': 'DT', 'position': '(0.0357143 0.0294118 0.05)', 'value': 0.000284876}
{'snapshotID': '3/5', 'field': 'T', 'position': '(0.178571 0.0294118 0.05)', 'value': 300.0}
{'snapshotID': '3/5', 'field': 'DT', 'position': '(0.0357143 0.0294118 0.05)', 'value': 0.000143284}
{'snapshotID': '3/200', 'field': 'T', 'position': '(0.0357143 0.5 0.05)', 'value': 270.733}
{'snapshotID': '3/200', 'field': 'DT', 'position': '(0.0357143 0.0294118 0.05)', 'value': 0.000143284}
```


#### Sampling (probing)

`readFromPoints` reads field values from the set of points, and returns a list of dictionaries.

Input example
```
from linAlg4Foam import linAlg4Foam

# Path to virtual OpenFoam directory
virtual_OF_dir = "OpenFoamTestCase/virtual_OF"

snapshots_list =[
    '1/100',
    '3/5'
]

points = [
    (0.1, 0.5, 0.05),
    (0.2, 0.5, 0.05),
    (0.4, 0.5, 0.05)
]

fields = ['T', 'DT']

## Sampling from points
results = linAlg4Foam.readFromPoints(virtual_OF_dir, snapshots_list, points, fields)
for item in results:
    print(item)

```


Output example
```
...
{'snapshotID': '7/130', 'point': '(0.1 0.5 0.05)', 'field': 'T', 'value': 336.211}
{'snapshotID': '7/130', 'point': '(0.2 0.5 0.05)', 'field': 'T', 'value': 333.071}
{'snapshotID': '7/130', 'point': '(0.4 0.5 0.05)', 'field': 'T', 'value': 307.728}
{'snapshotID': '7/130', 'point': '(0.1 0.5 0.05)', 'field': 'DT', 'value': 0.000275331}
{'snapshotID': '7/130', 'point': '(0.2 0.5 0.05)', 'field': 'DT', 'value': 0.000275331}
{'snapshotID': '7/130', 'point': '(0.4 0.5 0.05)', 'field': 'DT', 'value': 0.000275331}

```

#### Read from a physical sensor 

`physicalSensors` extracts minimal, maximal and average value from a 3D cylindrical part of the domain. This functionality firstly generates cell zones using 'topoSet' and then reads the fields from that specific zones. 

The sensors are listed as a list of dictionaries. Each sensor is defined with two points (on each side of the axis) and a radius.

Input example
```
from linAlg4Foam import linAlg4Foam

# Path to virtual OpenFoam directory
virtual_OF_dir = "OpenFoamTestCase/virtual_OF"

snapshots_list =[
    '1/100',
    '3/5'
]

fields = ['T', 'DT']

sensors = [
    {"point1": (0.0, 0.5, 0.0005), "point2": (0.1, 0.5, 0.0005), "radius": 0.1},
    {"point1": (0.2, 0.5, 0.0005), "point2": (0.3, 0.5, 0.0005), "radius": 0.1}
]

## Physical sensor
results = linAlg4Foam.physicalSensors(virtual_OF_dir, snapshots_list, sensors, fields)
for item in results:
    print(item)

```

Output example
```
...
{'snapshotID': '7/150', 'sensor': 'sensor0', 'field': 'DT', 'min': 0.000275331, 'max': 0.000275331, 'average': 0.000275331}
{'snapshotID': '7/150', 'sensor': 'sensor1', 'field': 'DT', 'min': 0.000275331, 'max': 0.000275331, 'average': 0.000275331}
{'snapshotID': '7/130', 'sensor': 'sensor0', 'field': 'T', 'min': 319.676, 'max': 320.017, 'average': 319.79}
{'snapshotID': '7/130', 'sensor': 'sensor1', 'field': 'T', 'min': 323.48, 'max': 323.886, 'average': 323.615}
{'snapshotID': '7/130', 'sensor': 'sensor0', 'field': 'DT', 'min': 0.000275331, 'max': 0.000275331, 'average': 0.000275331}
{'snapshotID': '7/130', 'sensor': 'sensor1', 'field': 'DT', 'min': 0.000275331, 'max': 0.000275331, 'average': 0.000275331}

```

### Field Operations

#### Linear combinations of fields

`linearCombination` calculates a linear combination of fields as:
$$
\sum_{i = 1}^N c_i \psi_i
$$

The inputs are:
- list of field names (fields),
- list of lists of snapshot paths (list_of_lists_of_snapshots),
- list of lists of coefficients (list_of_lists_of_coefficients),
- list of output directories (output_dirs).

The output directories should be specified in the same order as the
snapshots, since the function will create a new directory for each 
output directory and write new fields there.


Input example
```
from linAlg4Foam import linAlg4Foam

# Path to virtual OpenFoam directory
virtual_OF_dir = "OpenFoamTestCase/virtual_OF"

fields = ['T', 'DT']

list_of_lists_of_snapshots = [
    ['4/100', '5/100', '6/100'],
    ['1/200', '2/200', '3/200']
    ]

list_of_lists_of_coefficients = [
    [0.5, -0.5, 0.5],
    [10.0, -1.0e-4, 0.1]
    ]

output_dirs = ['temp_outputs/0', 'temp_outputs/1']

## Linear combination of fields
linAlg4Foam.linearCombination(virtual_OF_dir, list_of_lists_of_snapshots, fields, list_of_lists_of_coefficients, output_dirs)

```


## Adding new functions

1) Create new function object ('FOnewFunction') and place it into `OpenFoamFunctionObjects` directory.
2) In linAlg4Foam.py, create a function 'newFunction' and place it under 'class linAlg4Foam'.

An example of a new function definition (a set of input arguments may vary):
```
@staticmethod
def newFunction(virtual_OF_dir, snapshots_list, fields, points, list_of_lists_of_coefficients, output_dirs, sensors):
        function = 'newFunction'
        initialize(virtual_OF_dir, function)
        setSensors(virtual_OF_dir, sensors)
        execute(virtual_OF_dir=virtual_OF_dir, function=function, snapshots_list=snapshots_list, fields=fields, points=points, list_of_lists_of_coefficients = list_of_lists_of_coefficients, output_dirs = output_dirs)

        return
```

3) If an extra prompt is needed, add it into prompt_handlers list in basicFunctions.py.
